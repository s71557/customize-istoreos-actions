name: Build iStore OS 24.10 x86-alpha deepseek

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      lan_ip:
        description: 'è®¾ç½®LAN IPåœ°å€'
        required: true
        default: '192.168.100.1'
      os_name:
        description: 'è®¾ç½®ç³»ç»Ÿåç§°'
        required: true
        default: 'iStoreOS'
      enable_wifi:
        description: 'å¯ç”¨WiFi'
        required: true
        default: true
        type: boolean
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  schedule:
    - cron: 0 16 * * *

env:
  REPO_URL: https://github.com/istoreos/istoreos
  FEEDS_CONF: feeds.conf
  CONFIG_FILE: .config
  DIY_P1_SH: scripts/diy-part1.sh
  DIY_P2_SH: scripts/diy-part2.sh
  WORK_DIR: /mnt/workdir
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        REPO_BRANCH: [istoreos-24.10]
        ARCHITECTURE: [x86-alpha]
      fail-fast: false

    steps:
    - name: ğŸ› ï¸ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: â„¹ï¸ æ˜¾ç¤ºè¿è¡Œå™¨ä¿¡æ¯
      run: |
        echo "=== CPUä¿¡æ¯ ==="
        lscpu | grep -E 'Model name|Socket|Core|Thread'
        echo -e "\n=== å†…å­˜ä¿¡æ¯ ==="
        free -h
        echo -e "\n=== ç£ç›˜ä¿¡æ¯ ==="
        df -hT ${{ env.WORK_DIR }}
        echo -e "\n=== è¿è¡Œå™¨å‹å· ==="
        [ -f /proc/device-tree/model ] && cat /proc/device-tree/model || echo "Unknown model"

    - name: âš™ï¸ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android /opt/ghc
        sudo apt-get update -qq
        sudo apt-get install -qq $(cat $GITHUB_WORKSPACE/depends/ubuntu-22.04) \
          build-essential clang flex g++ gawk gcc-multilib gettext git libncurses5-dev \
          libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
        
        echo "=== å®‰è£…Pythonä¾èµ– ==="
        python3 -m pip install --upgrade pip pyelftools

        echo "=== æ¸…ç†ç³»ç»Ÿç©ºé—´ ==="
        sudo apt-get autoremove -qq --purge
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /var/lib/apt/lists/*

        echo "=== å‡†å¤‡ç¼–è¯‘ç›®å½• ==="
        sudo mkdir -p ${{ env.WORK_DIR }}
        sudo chown -R $USER:$USER ${{ env.WORK_DIR }}
        ln -sf ${{ env.WORK_DIR }} $GITHUB_WORKSPACE/openwrt

    - name: ğŸ“¥ å…‹éš†æºç 
      working-directory: ${{ env.WORK_DIR }}
      run: |
        git clone --depth 1 --branch ${{ matrix.REPO_BRANCH }} ${{ env.REPO_URL }} openwrt
        cd openwrt
        git submodule update --init --recursive

    - name: ğŸ“¦ ç¼“å­˜ç®¡ç†
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.WORK_DIR }}/openwrt/dl
          ${{ env.WORK_DIR }}/openwrt/ccache
        key: ${{ runner.os }}-${{ matrix.ARCHITECTURE }}-${{ hashFiles('${{ env.WORK_DIR }}/openwrt/feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.ARCHITECTURE }}-

    - name: ğŸ”„ æ›´æ–°Feeds
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        ./scripts/feeds clean
        [ -e $GITHUB_WORKSPACE/${{ env.FEEDS_CONF }} ] && cp $GITHUB_WORKSPACE/${{ env.FEEDS_CONF }} .
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: âš™ï¸ åº”ç”¨è‡ªå®šä¹‰é…ç½®
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        set -euxo pipefail
        
        # åº”ç”¨åŸºç¡€é…ç½®
        [ -e $GITHUB_WORKSPACE/${{ env.CONFIG_FILE }} ] && cp $GITHUB_WORKSPACE/${{ env.CONFIG_FILE }} .
        
        # è®¾ç½®ç½‘ç»œå‚æ•°
        sed -i "s/192\.168\.[0-9]*\.[0-9]*/${{ github.event.inputs.lan_ip }}/g" package/base-files/files/bin/config_generate
        sed -i "s/OpenWrt/${{ github.event.inputs.os_name }}/g" package/base-files/files/bin/config_generate
        
        # WiFiè®¾ç½®
        if ${{ github.event.inputs.enable_wifi }}; then
          sed -i 's/disabled=1/disabled=0/g' package/kernel/mac80211/files/lib/wifi/mac80211.sh
        fi
        
        # åº”ç”¨è‡ªå®šä¹‰è„šæœ¬
        [ -x $GITHUB_WORKSPACE/${{ env.DIY_P1_SH }} ] && $GITHUB_WORKSPACE/${{ env.DIY_P1_SH }}
        [ -x $GITHUB_WORKSPACE/${{ env.DIY_P2_SH }} ] && $GITHUB_WORKSPACE/${{ env.DIY_P2_SH }} ${{ matrix.ARCHITECTURE }}

    - name: ğŸš€ ç¼–è¯‘å‡†å¤‡
      working-directory: ${{ env.WORK_DIR }}/openwrt
      run: |
        make defconfig
        make download -j$(nproc)
        find dl -size -1024c -delete

    - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
      working-directory: ${{ env.WORK_DIR }}/openwrt
      timeout-minutes: 180
      run: |
        echo "å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) çº¿ç¨‹..."
        make -j$(nproc) || { echo "é¦–æ¬¡ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."; make -j1 V=s; }

    - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.ARCHITECTURE }}-${{ matrix.REPO_BRANCH }}-bin
        path: ${{ env.WORK_DIR }}/openwrt/bin

    - name: ğŸ·ï¸ åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
      if: success() && env.UPLOAD_RELEASE == 'true'
      id: create-release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ matrix.ARCHITECTURE }}-$(date +%Y%m%d)
        name: ${{ matrix.ARCHITECTURE }} Build $(date +%F)
        body: |
          **æ„å»ºä¿¡æ¯**
          - æ¶æ„: ${{ matrix.ARCHITECTURE }}
          - åˆ†æ”¯: ${{ matrix.REPO_BRANCH }}
          - ç¼–è¯‘æ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S")
          - é»˜è®¤IP: ${{ github.event.inputs.lan_ip }}
          - WiFiçŠ¶æ€: ${{ github.event.inputs.enable_wifi && 'å¯ç”¨' || 'ç¦ç”¨' }}
        files: ${{ env.WORK_DIR }}/openwrt/bin/targets/**/*

    - name: ğŸ§¹ æ¸…ç†æ—§æ„å»º
      uses: dev-drprasad/delete-older-releases@v0.2.1
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¡ SSHè¿æ¥ï¼ˆè°ƒè¯•ç”¨ï¼‰
      if: ${{ github.event.inputs.ssh == 'true' }}
      uses: mxschmitt/action-tmate@v3
      timeout-minutes: 30